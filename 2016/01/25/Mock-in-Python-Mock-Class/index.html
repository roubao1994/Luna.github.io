<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Mock in Python: Mock Class | Roubao1994</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The Mock ClassMock is a flexible mock object intended to replace the use of stubs and test doubles throughout your code. Mocks are callable and create attributes as new mocks when you access them [1].">
<meta property="og:type" content="article">
<meta property="og:title" content="Mock in Python: Mock Class">
<meta property="og:url" content="http://roubao1994.github.io/2016/01/25/Mock-in-Python-Mock-Class/index.html">
<meta property="og:site_name" content="Roubao1994">
<meta property="og:description" content="The Mock ClassMock is a flexible mock object intended to replace the use of stubs and test doubles throughout your code. Mocks are callable and create attributes as new mocks when you access them [1].">
<meta property="og:updated_time" content="2016-01-27T08:43:40.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mock in Python: Mock Class">
<meta name="twitter:description" content="The Mock ClassMock is a flexible mock object intended to replace the use of stubs and test doubles throughout your code. Mocks are callable and create attributes as new mocks when you access them [1].">
  
    <link rel="alternative" href="/atom.xml" title="Roubao1994" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Roubao1994</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://roubao1994.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Mock-in-Python-Mock-Class" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/25/Mock-in-Python-Mock-Class/" class="article-date">
  <time datetime="2016-01-25T10:19:31.000Z" itemprop="datePublished">2016-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Mock in Python: Mock Class
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="The_Mock_Class"><a href="#The_Mock_Class" class="headerlink" title="The Mock Class"></a>The Mock Class</h2><p>Mock is a flexible mock object intended to replace the use of stubs and test doubles throughout your code. Mocks are callable and create attributes as new mocks when you access them [1]. Accessing the same attribute will always return the same mock. Mocks record how you use them, allowing you to make assertions about what your code has done to them.</p>
<p>Mock 是一个灵活的mock对象，它可以在你的代码中替代stub和test doubles的使用。 Mocks可以被调用，并且创造作为新的mock的属性。 获取相同属性总是返回相同的mock。 Mocks记录了你如何使用它们，允许你确认你的code对他们做了什么。</p>
<p>MagicMock is a subclass of Mock with all the magic methods pre-created and ready to use. There are also non-callable variants, useful when you are mocking out objects that aren’t callable: NonCallableMock and NonCallableMagicMock</p>
<p>The patch() decorators makes it easy to temporarily replace classes in a particular module with a Mock object. By default patch() will create a MagicMock for you. You can specify an alternative class of Mock using the new_callable argument to patch().</p>
<p>MagicMock 是Mock的子类，但是它有预创建的所有magic methods. 同时还有non-callable的变量: NonCallableMock和NonCallableMock， 当你mock不被调用的对象时它们是有用的<br>patch() decorators使用Mock对象替代某个特定模块中的类变得容易。默认地， patch()会为你创建一个MagicMock。 你可以使用new_callable参数来实例化某个Mock类来patch.</p>
<p>以下摘自diabloneo <a href="http://segmentfault.com/a/1190000002965620" target="_blank" rel="external">《python mock 的入门》</a></p>
<p>Mock对象的一般用法是这样的：</p>
<ol>
<li>找到你要替换的对象，这个对象可以是一个类，一个函数或者是一个实例</li>
<li>实例化Mock类，得到一个mock对象，然后设置这个mock对象的行为，比如被调用时返回什么值，被访问成员时返回什么值</li>
<li>使用mock对象替换掉1中的对象</li>
<li>写测试代码</li>
</ol>
<h2 id="u57FA_u672C_u7528_u6CD5"><a href="#u57FA_u672C_u7528_u6CD5" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_request</span><span class="params">(url)</span>:</span></span><br><span class="line">  r = requests.get(url)</span><br><span class="line">  <span class="keyword">return</span> r.status_code</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">visit_ustack</span><span class="params">()</span>:</span></span><br><span class="line">  <span class="keyword">return</span> send_request(<span class="string">'http://www.ustack.com'</span>)</span><br></pre></td></tr></table></figure>
<p>外部模块调用visit_ustack来访问ustack</p>
<p>使用mock对象进行单元测试<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">import</span> mock</span><br><span class="line"><span class="keyword">import</span> client</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestClient</span><span class="params">(unittest.TestCase)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_success_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    success_send = mock.Mock(return_value = <span class="string">'200'</span>)</span><br><span class="line">    client.send_request = success_send</span><br><span class="line">    self.assertEquals(client.visit_ustack(), <span class="string">'200'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test_fail_request</span><span class="params">(self)</span>:</span></span><br><span class="line">    fail_send = mock.Mock(return_value = <span class="string">'404'</span>)</span><br><span class="line">    client.send_request = fail_send</span><br><span class="line">    self.assertEquals(client.visit_ustack(), <span class="string">'404'</span>)</span><br></pre></td></tr></table></figure></p>
<ol>
<li>找到要替换的对象： 我们要测试的是visit_ustack函数，因此需要替换掉send_request函数</li>
<li>实例化Mock类：函数的第一行</li>
<li>使用mock的对象替换掉一中的对象</li>
<li>assert</li>
</ol>
<h2 id="Mock_u7684_u53C2_u6570"><a href="#Mock_u7684_u53C2_u6570" class="headerlink" title="Mock的参数"></a>Mock的参数</h2><p>class unittest.mock.Mock(spec=None, side_effect=None, return_value=DEFAULT, wraps=None, name=None, spec_set=None, unsafe=False, **kwargs)</p>
<ol>
<li>name  标识一个mock</li>
<li><p>side_effect<br>它可以是一个mock对象被调用时调用的函数，或者是可迭代的（iterable)或者是一个异常（class or instance)<br>If you pass in a function it will be called with same arguments as the mock and unless the function returns the DEFAULT singleton the call to the mock will then return whatever the function returns. If the function returns DEFAULT then the mock will return its normal value (from the return_value).<br>如果你传入的是一个函数，它会以和mock对象相同的参数调用，并且除非这个函数返回DEFAULT，调用mock会返回函数的返回值。如果函数返回DEFAULT，则mock对象会返回它的normal value（从return_value中获取）<br>If you pass in an iterable, it is used to retrieve an iterator which must yield a value on every call. This value can either be an exception instance to be raised, or a value to be returned from the call to the mock (DEFAULT handling is identical to the function case).<br>如果传入一个iterable,那么它会用来获取一个迭代器，这个迭代器每当被调用都要返回一个值。这个值可以是一个被抛出的异常实例，也可以作为mock对象被调用时的返回值（对于DEFAULT的处理与函数一致）</p>
<h3 id="u793A_u4F8B"><a href="#u793A_u4F8B" class="headerlink" title="示例"></a>示例</h3><ul>
<li><p>抛出一个异常（用来测试代码对异常的处理）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mock = Mock(side_effect=Exception(<span class="string">'Boom'</span>))</span><br><span class="line">mock()</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回一组值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mock = Mock()</span><br><span class="line">mock.side_effect = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">mock(), mock(), mock()</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用callable</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mock = Mock(return_value=<span class="number">3</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">side_effect</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> DEFAULT</span><br><span class="line">mock.side_effect = side_effect</span><br><span class="line">mock()</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span><span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置None进行clear</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m = Mock(side_effect=KeyError, return_value=<span class="number">3</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> ...</span><br><span class="line">KeyError</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.side_effect = <span class="keyword">None</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m()</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>return_value</p>
</li>
<li>spec<br>它可以是一个字符串列表，也可以是一个已经存在的对象（一个class或者一个instance），这个对象作为mock对象的specification. 如果你传入的是一个对象，那么会调用该对象的dir方法来得到一个字符串列表（排除不支持的Magic属性和方法）。 获取不在这个list中的属性会抛出AttributeError.<br>如果spec是一个对象（而不是一个字符串列表），那么<strong>class</strong>返回spec对象的class. 这使得mock对象允许进行isinstance()测试。</li>
</ol>
<h2 id="Mock_u65AD_u8A00_u65B9_u6CD5"><a href="#Mock_u65AD_u8A00_u65B9_u6CD5" class="headerlink" title="Mock断言方法"></a>Mock断言方法</h2><ol>
<li><p>assert_called_with(*args, **kwargs)<br>这个方法用来测试mock方法是否获得了正确的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mock <span class="keyword">import</span> Mock</span><br><span class="line"></span><br><span class="line"><span class="comment"># the mock object</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">  _foovalue = <span class="number">123</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">callFoo</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">doFoo</span><span class="params">(self, arg)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">mockFoo = Mock(spec = Foo)</span><br><span class="line">mockFoo.doFoo(<span class="string">'a'</span>)</span><br><span class="line">mockFoo.doFoo.assert_called_with(<span class="string">'a'</span>)</span><br><span class="line"><span class="comment">#assertion passes</span></span><br><span class="line">mockFoo.doFoo(<span class="string">'b'</span>)</span><br><span class="line">mockFoo.doFoo.assert_called_with(<span class="string">'a'</span>)</span><br><span class="line"><span class="comment">#assertion fails</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>assert_called_once_with(*args, *kwargs)<br>断言测试对象是否以正确参数调用方法，并且mock方法只被调用一次</p>
</li>
<li><p>assert_any_call(*args, *kwargs)<br>断言测试对象是否以正确参数调用方法，不管mock方法和断言之间有多少其它的调用。与assert_called_once_with和assert_called_with不同， 这两个断言只考虑最近的一次断言。</p>
</li>
<li><p>assert_has_calls(calls, any_order=False)<br>断言测试对象是否调用了一组特定的calls， mock_calls 列表用来判定。<br>如果any_order 设置为false,那么调用的顺序必须相同，在这一组调用的前后可以有其他的calls。<br>如果any_order 设置为true, 那么调用的顺序无所谓，但是不能有其他的calls.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mock <span class="keyword">import</span> Mock,call</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">  _foovalue = <span class="number">123</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">callFoo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">doFoo</span><span class="params">(self, arg)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">mockFoo = Mock(spec = Foo)</span><br><span class="line"></span><br><span class="line">mockFoo.callFoo()</span><br><span class="line">mockFoo.doFoo(<span class="string">'a'</span>)</span><br><span class="line">mockFoo.doFoo(<span class="string">'b'</span>)</span><br><span class="line"></span><br><span class="line">fooCalls = [call.callFoo(), call.doFoo(<span class="string">'a'</span>), call.doFoo(<span class="string">'b'</span>)]</span><br><span class="line">mockFoo.assert_has_calls(fooCalls)</span><br><span class="line"><span class="comment">#assert passes</span></span><br><span class="line"></span><br><span class="line">fooCalls = [call.callFoo(), call.doFoo(<span class="string">'b'</span>), call.doFoo(<span class="string">'a'</span>)]</span><br><span class="line">mockFoo.assert_has_calls(fooCalls)</span><br><span class="line"><span class="comment">#Assertion Error</span></span><br><span class="line"></span><br><span class="line">mockFoo.assert_has_calls(fooCalls, any_order=<span class="keyword">True</span>)</span><br><span class="line"><span class="comment">#assert passes</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>assert_not_called(*args, **kwargs)<br>断言mock方法是否从未被调用</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://roubao1994.github.io/2016/01/25/Mock-in-Python-Mock-Class/" data-id="cijwl4s4e00005qubbpvr85kk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/01/25/mock-in-python-quick-guide/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">mock in python: quick guide</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mock/">mock</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/mock/" style="font-size: 10px;">mock</a> <a href="/tags/python/" style="font-size: 10px;">python</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/01/25/Mock-in-Python-Mock-Class/">Mock in Python: Mock Class</a>
          </li>
        
          <li>
            <a href="/2016/01/25/mock-in-python-quick-guide/">mock in python: quick guide</a>
          </li>
        
          <li>
            <a href="/2016/01/25/mock-in-python/">mock in python</a>
          </li>
        
          <li>
            <a href="/2016/01/23/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Roubao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>