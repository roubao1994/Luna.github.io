<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mock in python: quick guide | Roubao1994</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Quick GuideMock and MagicMock objects create all attributes and methods as you access them and store details of how they have been used. You can configure them, to specify return values or limit what">
<meta property="og:type" content="article">
<meta property="og:title" content="mock in python: quick guide">
<meta property="og:url" content="http://roubao1994.github.io/2016/01/25/mock-in-python-quick-guide/index.html">
<meta property="og:site_name" content="Roubao1994">
<meta property="og:description" content="Quick GuideMock and MagicMock objects create all attributes and methods as you access them and store details of how they have been used. You can configure them, to specify return values or limit what">
<meta property="og:updated_time" content="2016-01-25T10:16:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mock in python: quick guide">
<meta name="twitter:description" content="Quick GuideMock and MagicMock objects create all attributes and methods as you access them and store details of how they have been used. You can configure them, to specify return values or limit what">
  
    <link rel="alternative" href="/atom.xml" title="Roubao1994" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Roubao1994</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://roubao1994.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mock-in-python-quick-guide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/01/25/mock-in-python-quick-guide/" class="article-date">
  <time datetime="2016-01-25T08:42:43.000Z" itemprop="datePublished">2016-01-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      mock in python: quick guide
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Quick_Guide"><a href="#Quick_Guide" class="headerlink" title="Quick Guide"></a>Quick Guide</h1><p>Mock and MagicMock objects create all attributes and methods as you access them and store details of how they have been used. You can configure them, to specify return values or limit what attributes are available, and then make assertions about how they have been used:</p>
<p>Mock和MagicMock对象创建了所有的属性和方法，并且存储了它们该如何使用的细节。你可以通过配置它们来确定返回值或者限制属性的可见性，然后判断它们是如何被使用的。（即配置mock对象，并assert)<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> MagicMock</span><br><span class="line"></span><br><span class="line">thing = ProductionClass()</span><br><span class="line"><span class="comment"># config 返回值为3</span></span><br><span class="line">thing.method = MagicMock(return_value=<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 调用方法</span></span><br><span class="line">thing.method(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, key=<span class="string">'value'</span>)</span><br><span class="line">&gt;&gt;<span class="number">3</span></span><br><span class="line"><span class="comment"># assert方法是否是调用的正确的参数</span></span><br><span class="line">thing.method.assert_called_with(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, key=<span class="string">'value'</span>)</span><br></pre></td></tr></table></figure></p>
<p>side_effect allows you to perform side effects, including raising an exception when a mock is called:</p>
<p>sede_effect使得你可以实现sede effects, 包括当mock被调用时抛出一个异常：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mock = Mock(side_effect=KeyError(<span class="string">'foo'</span>))</span><br><span class="line"><span class="comment"># 调用mock时抛出一个异常</span></span><br><span class="line">mock()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> ...</span><br><span class="line">KeyError: <span class="string">'foo'</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">values=&#123;<span class="string">'a'</span>:<span class="number">1</span>, <span class="string">'b'</span>:<span class="number">2</span>, <span class="string">'c'</span>:<span class="number">3</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">side_effect</span><span class="params">(arg)</span>:</span></span><br><span class="line">  <span class="keyword">return</span> values[arg]</span><br><span class="line">mock.side_effect = side_effect</span><br><span class="line">mock(<span class="string">'a'</span>), mock(<span class="string">'b'</span>), mock(<span class="string">'c'</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">mock.side_effect = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line">mock(), mock(), mock()</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>Mock has many other ways you can configure it and control its behaviour. For example the spec argument configures the mock to take its specification from another object. Attempting to access attributes or methods on the mock that don’t exist on the spec will fail with an AttributeError.</p>
<p>有很多方法来配置Mock并控制它的行为。例如， spec参数来配置mock从其他对象获取specification. 尝试从mock对象获取在spec中不存在的属性和方法会抛出AttributeError.</p>
<p>The patch() decorator / context manager makes it easy to mock classes or objects in a module under test. The object you specify will be replaced with a mock (or other object) during the test and restored when the test ends:</p>
<p>patch() decorator / context manager 使得在测试中mock模块中的类或对象变得容易。你所指定的对象会在测试中被mock对象（或其他对象）所取代, 并在测试结束后恢复</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> patch</span><br><span class="line"></span><br><span class="line"><span class="decorator">@patch('module.ClassName2')</span></span><br><span class="line"><span class="decorator">@patch('module.ClassName1')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(MockClass1, MockClass2)</span>:</span></span><br><span class="line">  module.ClassName1()</span><br><span class="line">  module.ClassName2()</span><br><span class="line">  <span class="keyword">assert</span> MockClass1 <span class="keyword">is</span> module.ClassName1</span><br><span class="line">  <span class="keyword">assert</span> MockClass2 <span class="keyword">is</span> module.ClassName2</span><br><span class="line">  <span class="keyword">assert</span> MockClass1.called</span><br><span class="line">  <span class="keyword">assert</span> MockClass2.called</span><br></pre></td></tr></table></figure>
<p><strong>Note When you nest patch decorators the mocks are passed in to the decorated function in the same order they applied (the normal python order that decorators are applied). This means from the bottom up, so in the example above the mock for module.ClassName1 is passed in first.<br>With patch() it matters that you patch objects in the namespace where they are looked up. This is normally straightforward, but for a quick guide read where to patch.</strong></p>
<p><strong>注意: 当你使用嵌套的patch decorator时，mock对象传递给被装饰函数的顺序与他们applied的顺序相同（decorator在通常的python中的应用顺序）。这意味着是从下往上的，因此，在上面例子中，module.ClassName1C首先被传递。<br>通过patch(), 它表明你在他们所寻找的命名空间内注入你的对象。这个是很直观的，为了更迅速的了解，你可以阅读<a href="https://docs.python.org/dev/library/unittest.mock.html#where-to-patch" target="_blank" rel="external">where to patch</a></strong></p>
<p>As well as a decorator patch() can be used as a context manager in a with statement:</p>
<p>patch()还可以通过with语句变为上下文管理器：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> patch.object(ProductionClass, <span class="string">'method'</span>, return_value=<span class="keyword">None</span>) <span class="keyword">as</span> mock_method:</span><br><span class="line">  thing = ProductionClass</span><br><span class="line">  thing.method(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">mock_method.assert_called_once_with(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>There is also patch.dict() for setting values in a dictionary just during a scope and restoring the dictionary to its original state when the test ends:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">foo = &#123;<span class="string">'key'</span>: <span class="string">'value'</span>&#125;</span><br><span class="line">original = foo.copy()</span><br><span class="line"><span class="keyword">with</span> patch.dict(foo, &#123;<span class="string">'newKey'</span>, <span class="string">'newValue'</span>&#125;, clear=<span class="keyword">True</span>):</span><br><span class="line">  <span class="keyword">assert</span> foo == &#123;<span class="string">'newKey'</span>, <span class="string">'newValue'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> foo == original</span><br></pre></td></tr></table></figure></p>
<p>Mock 支持mock Python magic methods，最简单的使用magic methods的方式是通过MagicMock类. 你可以这么做：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mock = MagicMock()</span><br><span class="line">mock.__str__.return_value = <span class="string">'foobarbaz'</span></span><br><span class="line">str(mock)</span><br><span class="line">mock.__str__.assert_called_with()</span><br></pre></td></tr></table></figure></p>
<p>Mock allows you to assign functions (or other Mock instances) to magic methods and they will be called appropriately. The MagicMock class is just a Mock variant that has all of the magic methods pre-created for you (well, all the useful ones anyway).<br>The following is an example of using magic methods with the ordinary Mock class:</p>
<p>Mock使得你将函数（或者其他Mock实例）assign到magic methods上，并且它们能够被恰当地调用。 MaigicMock类只是一个含有所有magic methods方法的Mock变量。<br>以下是一个通过通常的Mock类使用magic methods的案例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mock = Mock()</span><br><span class="line">mock.__str__ = Mock(return_value=<span class="string">'wheeeee'</span>)</span><br><span class="line">str(mock)</span><br></pre></td></tr></table></figure></p>
<p>For ensuring that the mock objects in your tests have the same api as the objects they are replacing, you can use auto-speccing. Auto-speccing can be done through the autospec argument to patch, or the create_autospec() function. Auto-speccing creates mock objects that have the same attributes and methods as the objects they are replacing, and any functions and methods (including constructors) have the same call signature as the real object.<br>This ensures that your mocks will fail in the same way as your production code if they are used incorrectly:</p>
<p>为了确保你在测试中的mock对象有和它们替代对象相同的api， 你可以使用 <strong>auto-speccing</strong>. Auto-speccing 可以通过autoapec参数或者create_autospec()函数来实现。 Auto-speccing创建了与它们所替代的对象有相同属性和方法的mock对象。<br>这确保了当它们被错误使用时，你的mock对象和你的production code一样也会失败，并且方式一样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unittest.mock <span class="keyword">import</span> create_autospec</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">function</span><span class="params">(a, b ,c)</span>:</span></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">mock_function = create_autospec(function, return_value=<span class="string">'fishy'</span>)</span><br><span class="line">mock_function(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>fishy</span><br><span class="line">mock_function.assert_called_once_with(<span class="number">1</span>, <span class="number">2</span> ,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">mock_function(<span class="string">'wrong params'</span>)</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line"> ...</span><br><span class="line">TypeError: &lt;<span class="keyword">lambda</span>&gt;() takes exactly <span class="number">3</span> arguments (<span class="number">1</span> given</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://roubao1994.github.io/2016/01/25/mock-in-python-quick-guide/" data-id="cijwl4s5100065qub29g76h7q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mock/">mock</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/01/25/Mock-in-Python-Mock-Class/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Mock in Python: Mock Class
        
      </div>
    </a>
  
  
    <a href="/2016/01/25/mock-in-python/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">mock in python</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/mock/">mock</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/mock/" style="font-size: 10px;">mock</a> <a href="/tags/python/" style="font-size: 10px;">python</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/01/25/Mock-in-Python-Mock-Class/">Mock in Python: Mock Class</a>
          </li>
        
          <li>
            <a href="/2016/01/25/mock-in-python-quick-guide/">mock in python: quick guide</a>
          </li>
        
          <li>
            <a href="/2016/01/25/mock-in-python/">mock in python</a>
          </li>
        
          <li>
            <a href="/2016/01/23/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Roubao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>